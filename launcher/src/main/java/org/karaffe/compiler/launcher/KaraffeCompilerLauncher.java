package org.karaffe.compiler.launcher;

import org.antlr.v4.runtime.ANTLRFileStream;
import org.antlr.v4.runtime.CommonTokenStream;
import org.karaffe.compiler.base.util.DiagnosticInfo;
import org.karaffe.compiler.base.util.LogLevelConfigurator;
import org.karaffe.compiler.base.util.SystemPropertyConfigurator;
import org.karaffe.compiler.frontend.karaffe.antlrautogenerated.KaraffeLexer;
import org.karaffe.compiler.frontend.karaffe.antlrautogenerated.KaraffeParser;
import org.karaffe.compiler.frontend.karaffe.ast.CompilationUnit;
import org.karaffe.compiler.frontend.karaffe.listener.ASTBuilder;
import org.karaffe.compiler.frontend.karaffe.transformer.AbstractTransformer;
import org.karaffe.compiler.frontend.karaffe.transformer.TransformerBuilder;

import java.io.File;
import java.io.InputStream;
import java.io.PrintStream;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Set;
import java.util.stream.Collectors;

public class KaraffeCompilerLauncher {

    private InputStream stdIn = System.in;
    private PrintStream stdOut = System.out;
    private PrintStream stdErr = System.err;

    public KaraffeCompilerLauncher(InputStream stdIn, PrintStream stdOut, PrintStream stdErr) {
        this.stdIn = stdIn;
        this.stdOut = stdOut;
        this.stdErr = stdErr;
    }

    public KaraffeCompilerLauncher() {

    }

    public static void main(String[] args) throws Exception {
        KaraffeCompilerLauncher launcher = new KaraffeCompilerLauncher();
        launcher.run(args);
    }

    public void run(String[] args) throws Exception {
        if (args.length == 0) {
            stdErr.println(usage());
            return;
        }

        new LogLevelConfigurator(args).update();
        new SystemPropertyConfigurator(args).updateSystemProperty();

        if (hasFlag("--version", args)) {
            stdOut.println("Karaffe Compiler v0.1.0");
            return;
        }

        if (hasFlag("--diag", args)) {
            stdOut.println(DiagnosticInfo.INSTANCE.toString());
        }

        Set<AbstractTransformer> transformers = new TransformerBuilder().getTransformers();
        final boolean isShowPhases = hasFlag("--show-phases", args);
        if (isShowPhases) {
            transformers.stream().map(AbstractTransformer::getTransformerName).forEach(stdOut::println);
        }

        List<File> files = Arrays.stream(args).map(File::new).filter(File::exists).collect(Collectors.toList());

        ASTBuilder astBuilder = new ASTBuilder();
        Map<String, KaraffeParser.CompilationUnitContext> contexts = new HashMap<>(files.size());

        for (File file : files) {
            String fileName = file.getAbsolutePath();
            KaraffeLexer lexer = new KaraffeLexer(new ANTLRFileStream(fileName));
            lexer.removeErrorListeners();
            lexer.addErrorListener(astBuilder);
            KaraffeParser parser = new KaraffeParser(new CommonTokenStream(lexer));
            parser.removeErrorListeners();
            parser.removeParseListeners();
            parser.addParseListener(astBuilder);
            parser.addErrorListener(astBuilder);
            KaraffeParser.CompilationUnitContext context = parser.compilationUnit();
            contexts.put(fileName, context);

            if (astBuilder.hasError()) {
                return;
            }
        }

        CompilationUnit compilationUnit = astBuilder.getCompilationUnit();

        final boolean isPrintTree = hasFlag("--print-tree", args);

        if (isPrintTree) {
            stdOut.println("===");
            stdOut.println(compilationUnit);
        }

        CompilationUnit cu = compilationUnit;
        String lastString = cu.toString();
        for (AbstractTransformer transformer : transformers) {
            cu = transformer.transform(cu);
            if (isPrintTree) {
                stdOut.println("=== After : " + transformer.getTransformerName() + " ===");
                if (lastString.equals(cu.toString())) {
                    stdOut.println("No change.");
                } else {
                    stdOut.println(cu);
                }
            }
            lastString = cu.toString();
        }
    }

    private boolean hasFlag(String flagName, String[] args) {
        return Arrays.stream(args).anyMatch(arg -> arg.equals(flagName));
    }

    private String usage() {
        List<String> output = new ArrayList<>();
        output.add("Usage: krfc [source files]");
        output.add("where possible options include:");
        output.add("  -Dkey=value");
        output.add("  --diag");
        output.add("  --log:<loglevel>");
        output.add("  --info");
        output.add("  --debug");
        output.add("  --trace");
        output.add("  --show-phases");
        output.add("  --print-tree");
        output.add("  --version");
        return String.join("\n", output);
    }
}
