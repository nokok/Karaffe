package org.karaffe.compiler.launcher;

import org.antlr.v4.runtime.ANTLRFileStream;
import org.antlr.v4.runtime.CommonTokenStream;
import org.karaffe.compiler.base.util.SystemPropertyConfigurator;
import org.karaffe.compiler.frontend.karaffe.antlrautogenerated.KaraffeLexer;
import org.karaffe.compiler.frontend.karaffe.antlrautogenerated.KaraffeParser;
import org.karaffe.compiler.frontend.karaffe.ast.CompilationUnit;
import org.karaffe.compiler.frontend.karaffe.listener.ASTBuilder;
import org.karaffe.compiler.frontend.karaffe.transformer.AbstractTransformer;
import org.karaffe.compiler.frontend.karaffe.transformer.TransformerBuilder;

import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;
import java.util.Set;

public class KaraffeCompilerLauncher {
    public static void main(String[] args) throws Exception {
        new KaraffeCompilerLauncher().run(args);
    }

    private void run(String[] args) throws Exception {
        if (args.length == 0) {
            System.out.println(usage());
            return;
        }
        //new LibraryLoader().loadJars();
        new SystemPropertyConfigurator(args).updateSystemProperty();

        String fileName = Arrays.asList(args).stream().filter(arg -> arg.endsWith(".krf")).findFirst().orElseThrow(IllegalArgumentException::new);

        KaraffeLexer lexer = new KaraffeLexer(new ANTLRFileStream(fileName));
        ASTBuilder astBuilder = new ASTBuilder();
        lexer.removeErrorListeners();
        lexer.addErrorListener(astBuilder);
        KaraffeParser parser = new KaraffeParser(new CommonTokenStream(lexer));
        parser.removeErrorListeners();
        parser.removeParseListeners();
        parser.addParseListener(astBuilder);
        parser.addErrorListener(astBuilder);
        parser.compilationUnit();

        if (astBuilder.hasError()) {
            return;
        }

        CompilationUnit compilationUnit = astBuilder.getCompilationUnit();

        boolean isShowPhases = Arrays.asList(args).contains("--show-phases");
        boolean isPrintTree = Arrays.asList(args).contains("--print-tree");


        if (isPrintTree) {
            System.out.println("===");
            System.out.println(compilationUnit);
        }
        TransformerBuilder builder = new TransformerBuilder();
        Set<AbstractTransformer> transformers = builder.getTransformers();


        if (isShowPhases) {
            transformers.stream().map(AbstractTransformer::getTransformerName).forEach(System.out::println);
        }


        CompilationUnit cu = compilationUnit;
        for (AbstractTransformer transformer : transformers) {
            cu = transformer.transform(cu);
            if (isPrintTree) {
                System.out.println("=== After : " + transformer.getTransformerName() + " ===");
                System.out.println(cu);
            }
        }
    }

    private String usage() {
        List<String> output = new ArrayList<>();
        output.add("Usage: krfc [source files]");
        output.add("where possible options include:");
        output.add("  --show-phases");
        output.add("  --print-tree");
        return String.join("\n", output);
    }
}
